(function(){var t,e,r,o,i,n={}.hasOwnProperty,h=function(t,e){function r(){this.constructor=t}for(var o in e)n.call(e,o)&&(t[o]=e[o]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};i=ABM.Util,ABM.DataSet=e=function(){function e(t,e,r,o){null==t&&(t=0),null==e&&(e=0),null==r&&(r=[]),this.model=o,this.setDefaults(),this.reset(t,e,r)}return e.patchDataSet=function(t){return new o(t)},e.importImageDataSet=function(t,e,o,n,h){var a;return null==o&&(o=i.pixelByte(0)),null==n&&(n=Uint8ClampedArray),a=new r(null,o,n,h),i.importImage(t,function(t){return a.parse(t),null!=e?e(a):void 0}),a},e.importAscDataSet=function(e,r){var o;return o=new t,i.xhrLoadFile(e,"GET","text",function(t){return o.parse(t),null!=r?r(o):void 0}),o},e.prototype.reset=function(t,e,r){return this.width=t,this.height=e,this.data=r,r.length!==t*e&&i.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},e.prototype.checkXY=function(t,e){return t>=0&&t<=this.width-1&&e>=0&&e<=this.height-1?void 0:i.error("x,y out of range: "+t+","+e)},e.prototype.setDefaults=function(){return this.useNearest=!1,this.crop=!1,this.normalizeImage=!0,this.alpha=255,this.gray=!0},e.prototype.setSampler=function(t){this.useNearest=t},e.prototype.setConvolveCrop=function(t){this.crop=t},e.prototype.setImageNormalize=function(t){this.normalizeImage=t},e.prototype.setImageAlpha=function(t){this.alpha=t},e.prototype.setImageGray=function(t){this.gray=t},e.prototype.setModel=function(t){this.model=t},e.prototype.sample=function(t,e){return this.useNearest?this.nearest(t,e):this.bilinear(t,e)},e.prototype.nearest=function(t,e){return this.getXY(Math.round(t),Math.round(e))},e.prototype.bilinear=function(t,e){var r,o,i,n,h,a,s,l,u,p,c,d,f;return this.checkXY(t,e),u=Math.floor(t),p=Math.floor(e),s=this.toIndex(u,p),l=this.width,t-=u,e-=p,r=1-t,o=1-e,i=this.data[s],n=null!=(c=this.data[s+l])?c:0,h=null!=(d=this.data[++s])?d:0,a=null!=(f=this.data[s+l])?f:0,i*r*o+h*t*o+n*r*e+a*t*e},e.prototype.toIndex=function(t,e){return t+e*this.width},e.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},e.prototype.getXY=function(t,e){return this.checkXY(t,e),this.data[this.toIndex(t,e)]},e.prototype.setXY=function(t,e,r){return this.checkXY(t,e),this.data[this.toIndex(t,e)]=r},e.prototype.toString=function(t,e){var r,o,n,h,a;for(null==t&&(t=2),null==e&&(e=", "),n="width: "+this.width+" height: "+this.height+" data:",r=0>t?this.data:i.aToFixed(this.data,t),o=h=0,a=this.height;a>=0?a>h:h>a;o=a>=0?++h:--h)n+="\n"+(""+o+": "+r.slice(o*this.width,(o+1)*this.width));return n.replace(/,/g,e)},e.prototype.toImage=function(){return this.toContext().canvas},e.prototype.toContext=function(){var t,e,r,o,n,h,a,s,l,u;for(t=i.createCtx(this.width,this.height),n=t.getImageData(0,0,this.width,this.height),s=n.data,r=this.normalizeImage?this.gray?i.normalize8(this.data):i.normalizeInt(this.data,0,Math.pow(2,24)-1):function(){var t,r,o,i;for(o=this.data,i=[],t=0,r=o.length;r>t;t++)e=o[t],i.push(Math.round(e));return i}.call(this),o=l=0,u=r.length;u>l;o=++l)a=r[o],h=4*o,this.gray?(s[h]=s[h+1]=s[h+2]=Math.floor(a),s[h+3]=this.alpha):(s[h]=a>>16&255,s[h+1]=a>>8&255,s[h+2]=255&a,s[h+3]=this.normalizeImage?this.alpha:s[h+3]=a>>24&255);return t.putImageData(n,0,0),t},e.prototype.toDataUrl=function(){return i.ctxToDataUrl(this.toContext())},e.prototype.toDrawing=function(t){var e;return null==t&&(t=this.model),t.patches.installDrawing(e=this.toImage()),e},e.prototype.toPatchColors=function(t){var e;return null==t&&(t=this.model),t.patches.installColors(e=this.toImage()),e},e.prototype.toPatchVar=function(t,e){var r,o,i,n,h,a,s;if(null==e&&(e=this.model),(i=e.patches).length===this.data.length)for(r=n=0,a=i.length;a>n;r=++n)o=i[r],o[t]=this.data[r];else for(h=0,s=i.length;s>h;h++)o=i[h],o[t]=this.patchSample(o.x,o.y,e);return null},e.prototype.coordSample=function(t,e,r,o,i,n){var h,a;return h=(t-r)*(this.width-1)/i,a=(o-e)*(this.height-1)/n,this.sample(h,a)},e.prototype.patchSample=function(t,e,r){var o;return null==r&&(r=this.model),o=r.world,this.coordSample(t,e,o.minXcor,o.maxYcor,o.numX,o.numY)},e.prototype.normalize=function(t,r){return new e(this.width,this.height,i.normalize(this.data,t,r),this.model)},e.prototype.normalize8=function(){return new e(this.width,this.height,i.normalize8(this.data),this.model)},e.prototype.resample=function(t,r){var o,i,n,h,a,s,l,u,p;if(t===this.width&&r===this.height)return new e(t,r,this.data,this.model);for(o=[],n=(this.width-1)/(t-1),s=(this.height-1)/(r-1),a=u=0;r>u;a=u+=1)for(i=p=0;t>p;i=p+=1)h=i*n,l=a*s,o.push(this.sample(h,l));return new e(t,r,o,this.model)},e.prototype.neighborhood=function(t,e,r){var o,n,h,a,s,l;for(null==r&&(r=[]),r.length=0,n=s=-1;1>=s;n=++s)for(o=l=-1;1>=l;o=++l)h=i.clamp(t+o,0,this.width-1),a=i.clamp(e+n,0,this.height-1),r.push(this.data[this.toIndex(h,a)]);return r},e.prototype.convolve=function(t,r){var o,n,h,a,s,l,u,p,c,d;for(null==r&&(r=1),o=[],h=[],this.crop?(l=p=1,n=this.height-1,a=this.width-1):(l=p=0,n=this.height,a=this.width),u=c=p;n>c;u=c+=1)for(s=d=l;a>d;s=d+=1)this.neighborhood(s,u,h),o.push(i.aSum(i.aPairMul(t,h))*r);return new e(a-l,n-p,o,this.model)},e.prototype.dzdx=function(t,e){return null==t&&(t=2),null==e&&(e=1/8),this.convolve([-1,0,1,-t,0,t,-1,0,1],e)},e.prototype.dzdy=function(t,e){return null==t&&(t=2),null==e&&(e=1/8),this.convolve([1,t,1,0,0,0,-1,-t,-1],e)},e.prototype.laplace8=function(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])},e.prototype.laplace4=function(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])},e.prototype.blur=function(t){return null==t&&(t=.0625),this.convolve([1,2,1,2,4,2,1,2,1],t)},e.prototype.edge=function(){return this.convolve([1,1,1,1,-7,1,1,1,1])},e.prototype.filter=function(t){var r;return new e(this.width,this.height,function(){var e,o,i,n;for(i=this.data,n=[],e=0,o=i.length;o>e;e++)r=i[e],n.push(t(r));return n}.call(this),this.model)},e.prototype.slopeAndAspect=function(t,r){var o,n,h,a,s,l,u,p,c,d,f,m,g;for(null==t&&(t=!0),null==r&&(r=!0),n=this.dzdx(),h=this.dzdy(),o=[],p=[],l=n.height,c=n.width,f=m=0;l>m;f=m+=1)for(d=g=0;c>g;d=g+=1){for(a=n.getXY(d,f),s=h.getXY(d,f),p.push(Math.atan(Math.sqrt(a*a+s*s)));t&&a===s;)a+=i.randomNormal(0,1e-4),s+=i.randomNormal(0,1e-4);u=a===s&&0===s?0/0:Math.atan2(-s,-a),r&&0>u&&(u+=2*Math.PI),o.push(u)}return p=new e(c,l,p,this.model),o=new e(c,l,o,this.model),i.aToObj([p,o,n,h],["slope","aspect","dzdx","dzdy"])},e.prototype.subset=function(t,r,o,n){var h,a,s,l,u,p,c;for((t+o>this.width||r+n>this.height)&&i.error("subSet: params out of range"),h=[],s=l=r,p=r+n;p>l;s=l+=1)for(a=u=t,c=t+o;c>u;a=u+=1)h.push(this.getXY(a,s));return new e(o,n,h,this.model)},e}(),ABM.AscDataSet=t=function(t){function e(t,r){this.str=null!=t?t:"",this.model=r,e.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return h(e,t),e.prototype.parse=function(t){var e,r,o,i,n,h,a,s,l;for(this.str=t,i=t.split("\n"),this.header={},e=n=0;5>=n;e=++n)r=i[e].split(/\s+/),this.header[r[0].toLowerCase()]=parseFloat(r[1]);for(e=h=0,s=this.header.nrows;s>h;e=h+=1){for(o=i[6+e].trim().split(" "),e=a=0,l=o.length;l>=0?l>a:a>l;e=l>=0?++a:--a)o[e]=parseFloat(o[e]);this.data=this.data.concat(o)}return this.reset(this.header.ncols,this.header.nrows,this.data)},e}(e),ABM.ImageDataSet=r=function(t){function e(t,r,o,n,h){this.f=null!=r?r:i.pixelByte(0),this.arrayType=null!=o?o:Uint8ClampedArray,this.rowsPerSlice=n,this.model=h,e.__super__.constructor.call(this),null!=t&&this.parse(t)}return h(e,t),e.prototype.parse=function(t){var e;return this.rowsPerSlice||(this.rowsPerSlice=t.height),e=i.imageRowsToData(t,this.rowsPerSlice,this.f,this.arrayType),this.reset(t.width,t.height,e)},e}(e),ABM.PatchDataSet=o=function(t){function e(t,r,o){var n,h,a,s,l,u;for(null==r&&(r=Array),this.model=o,n=new r((s=this.model.patches).length),i.isString(t)&&(t=i.propFcn(t)),h=l=0,u=s.length;u>l;h=++l)a=s[h],n[h]=t(a);e.__super__.constructor.call(this,s.numX,s.numY,n),this.useNearest=!0}return h(e,t),e.prototype.toPatchVar=function(t){var e,r,o,i,n;for(n=this.model.patches,e=o=0,i=n.length;i>o;e=++o)r=n[e],r[t]=this.data[e];return null},e}(e)}).call(this);