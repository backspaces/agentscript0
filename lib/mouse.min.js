(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}};t=ABM.util,ABM.Mouse=function(){function s(t,s){this.model=t,this.callback=s,this.delegateMouseOverAndOutEvents=e(this.delegateMouseOverAndOutEvents,this),this.delegateDragEvents=e(this.delegateDragEvents,this),this.computeEventTypes=e(this.computeEventTypes,this),this.handleMouseEvent=e(this.handleMouseEvent,this),this.handleStep=e(this.handleStep,this),this.handleMouseMove=e(this.handleMouseMove,this),this.handleMouseUp=e(this.handleMouseUp,this),this.handleMouseDown=e(this.handleMouseDown,this),this.lastX=1/0,this.lastY=1/0,this.div=this.model.div,this.lastAgentsHovered=[],this.draggingAgents=[],this.divOffset=this.model.div.getBoundingClientRect(),this.start()}return s.prototype.start=function(){return this.div.addEventListener("mousedown",this.handleMouseDown,!1),document.body.addEventListener("mouseup",this.handleMouseUp,!1),this.div.addEventListener("mousemove",this.handleMouseMove,!1),this.model.on("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},s.prototype.stop=function(){return this.div.removeEventListener("mousedown",this.handleMouseDown,!1),document.body.removeEventListener("mouseup",this.handleMouseUp,!1),this.div.removeEventListener("mousemove",this.handleMouseMove,!1),this.model.off("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},s.prototype.handleMouseDown=function(t){return this.down=!0,this.moved=!1,this.handleMouseEvent(t)},s.prototype.handleMouseUp=function(t){return this.down=!1,this.moved=!1,this.handleMouseEvent(t)},s.prototype.handleMouseMove=function(t){return this.setXY(t),this.moved=!0,this.handleMouseEvent(t)},s.prototype.handleStep=function(){return isNaN(this.x)?void 0:this.delegateMouseOverAndOutEvents(this.x,this.y)},s.prototype.handleMouseEvent=function(t){var e;return e=this.computeEventTypes(),this.delegateEventsToAllAgents(e,t),null!=this.callback?this.callback(t):void 0},s.prototype.getEventPos=function(t){var e,s;return e=0,s=0,t.pageX||t.pageY?(e=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(e=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:e-this.divOffset.left,y:s-this.divOffset.top}},s.prototype.setXY=function(t){var e,s;return e=this.getEventPos(t),this.lastX=this.x,this.lastY=this.y,this.pixX=e.x,this.pixY=e.y,s=this.model.patches.pixelXYtoPatchXY(this.pixX,this.pixY),this.x=s[0],this.y=s[1],this.dx=this.lastX-this.x,this.dy=this.lastY-this.y},s.prototype.computeEventTypes=function(){var t;return t=[],this.down&&!this.moved&&t.push("mousedown"),this.down||this.moved||t.push("mouseup"),this.down&&this.moved&&(this.dragging||t.push("dragstart"),this.dragging=!0),!this.down&&this.dragging&&(this.dragging=!1,this.dragEnd=!0),this.moved&&t.push("mousemove"),t},s.prototype.delegateEventsToAllAgents=function(t,e){var s;return s=this.delegateEventsToAgentsAtPoint(t,this.x,this.y,e),s||(s=this.delegateEventsToLinksAtPoint(t,this.x,this.y,e)),s||this.delegateEventsToPatchAtPoint(t,this.x,this.y,e),this.delegateDragEvents(this.x,this.y,e),this.delegateMouseOverAndOutEvents(this.x,this.y,e)},s.prototype.delegateEventsToPatchAtPoint=function(t,e,s,i){var n,o,h,d,r;for(n=this.model.patches.patch(e,s),r=[],h=0,d=t.length;d>h;h++)o=t[h],r.push(this.emitAgentEvent(o,n,this.mouseEvent(n,i)));return r},s.prototype.delegateEventsToAgentsAtPoint=function(t,e,s,i){var n,o,h,d,r,a,u,l,v,g,p,m;for(o=this.model.patches.patch(e,s),p=o.n.concat(o),r=0,l=p.length;l>r;r++)for(h=p[r],m=h.agentsHere(),a=0,v=m.length;v>a;a++)if(n=m[a],n.hitTest(e,s)){for(u=0,g=t.length;g>u;u++)d=t[u],this.emitAgentEvent(d,n,this.mouseEvent(n,i));return n}},s.prototype.delegateEventsToLinksAtPoint=function(t,e,s,i){var n,o,h,d,r,a,u,l;for(l=this.model.links,d=0,a=l.length;a>d;d++)if(n=l[d],n.hitTest(e,s)){for(o=this.mouseEvent(n,i),r=0,u=t.length;u>r;r++)h=t[r],this.emitAgentEvent(h,n,o);return n}},s.prototype.emitAgentEvent=function(t,e,s){return"dragstart"===t&&this.draggingAgents.push(e),e.breed.emit(t,s),null!=e.breed.mainSet?e.breed.mainSet.emit(t,s):void 0},s.prototype.delegateDragEvents=function(t,e,s){var i,n,o,h,d;for(d=this.draggingAgents,o=0,h=d.length;h>o;o++)i=d[o],n=this.mouseEvent(i,s),this.moved&&this.emitAgentEvent("drag",i,n),this.dragEnd&&this.emitAgentEvent("dragend",i,n);return this.dragEnd?(this.draggingAgents=[],this.dragEnd=!1):void 0},s.prototype.delegateMouseOverAndOutEvents=function(e,s,i){var n,o,h,d,r,a,u,l,v,g,p,m,c;for(d={},h=[],a=this.model.patches.patch(e,s),h=t.clone(this.model.links),c=a.n.concat(a),l=0,g=c.length;g>l;l++)u=c[l],h=h.concat(u.agentsHere());for(v=0,p=h.length;p>v;v++)n=h[v],n.hitTest(e,s)&&(null==d[m=n.breed.name]&&(d[m]={}),d[n.breed.name][n.id]=n,this.lastAgentsHovered[n.breed.name]&&n.id in this.lastAgentsHovered[n.breed.name]||this.emitAgentEvent("mouseover",n,this.mouseEvent(n,i)));for(r in this.lastAgentsHovered)for(o in this.lastAgentsHovered[r])d[r]&&o in d[r]||(n=this.lastAgentsHovered[r][o],this.emitAgentEvent("mouseout",n,this.mouseEvent(n,i)));return this.lastAgentsHovered=d},s.prototype.mouseEvent=function(t,e){return{target:t,patchX:this.x,patchY:this.y,dx:this.dx,dy:this.dy,originalEvent:e}},s}()}).call(this);