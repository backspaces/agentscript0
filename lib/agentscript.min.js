(function(){var ABM,root,u,_base,__hasProp={}.hasOwnProperty,__slice=[].slice,__indexOf=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1},__extends=function(t,n){function e(){this.constructor=t}for(var i in n)__hasProp.call(n,i)&&(t[i]=n[i]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__bind=function(t,n){return function(){return t.apply(n,arguments)}};this.ABM=ABM={},root=this,function(){var t,n,e,i;for(this.requestAnimFrame=this.requestAnimationFrame||null,this.cancelAnimFrame=this.cancelAnimationFrame||null,i=["ms","moz","webkit","o"],n=0,e=i.length;e>n;n++)t=i[n],this.requestAnimFrame||(this.requestAnimFrame||(this.requestAnimFrame=this[t+"RequestAnimationFrame"]),this.cancelAnimFrame||(this.cancelAnimFrame=this[t+"CancelAnimationFrame"]),this.cancelAnimFrame||(this.cancelAnimFrame=this[t+"CancelRequestAnimationFrame"]));return this.requestAnimFrame||(this.requestAnimFrame=function(t){return this.setTimeout(t,1e3/60)}),this.cancelAnimFrame||(this.cancelAnimFrame=function(t){return this.clearTimeout(t)})}(),ABM.util=u={error:function(t){throw new Error(t)},MaxINT:Math.pow(2,53),MinINT:-Math.pow(2,53),MaxINT32:2147483647,MinINT32:-2147483648,Colors:{black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],yellow:[255,255,0],green:[0,128,0],blue:[0,0,255],purple:[128,0,128],brown:[165,42,42]},isArray:function(t){return!(!(t&&t.concat&&t.unshift)||t.callee)},isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},isString:function(t){return!!(""===t||t&&t.charCodeAt&&t.substr)},isNumber:function(t){return!("number"!=typeof t)},randomSeed:function(t){return null==t&&(t=123456),Math.random=function(){var n;return n=1e4*Math.sin(t++),n-Math.floor(n)}},randomInt:function(t,n){return null==t&&(t=2),null==n&&(n=null),Math.floor(this.randomFloat(t,n))},randomFloat:function(t,n){var e;return null==t&&(t=1),null==n&&(n=null),null===n?(n=t,e=0):e=t,e+Math.random()*(n-e)},randomNormal:function(t,n){var e,i,r;return null==t&&(t=0),null==n&&(n=1),i=1-Math.random(),r=Math.random(),e=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*r),e*n+t},randomCentered:function(t){return this.randomFloat(-t/2,t/2)},onceEvery:function(t){return null==t&&(t=100),1===this.randomInt(t)},log10:function(t){return Math.log(t)/Math.LN10},log2:function(t){return this.logN(t,2)},logN:function(t,n){return Math.log(t)/Math.log(n)},mod:function(t,n){return(t%n+n)%n},wrap:function(t,n,e){return n+this.mod(t-n,e-n)},clamp:function(t,n,e){return Math.max(Math.min(t,e),n)},sign:function(t){return 0>t?-1:1},colorFromString:function(t){var n;return n=this.Colors[t],this.isArray(n)||this.error("unless you're using basic colors, specify an rgb array [nr, nr, nr]"),n},randomColor:function(){var t,n,e;for(t=[],n=e=0;2>=e;n=++e)t[n]=this.randomInt(256);return t},randomGray:function(t,n){var e,i,r,o;for(null==t&&(t=64),null==n&&(n=192),e=[],r=this.randomInt(t,n),i=o=0;2>=o;i=++o)e[i]=r;return e},randomMapColor:function(t){return null==t&&(t=[0,63,127,191,255]),[this.sample(t),this.sample(t),this.sample(t)]},randomBrightColor:function(){return this.randomMapColor([0,127,255])},fractionOfColor:function(t,n){var e,i,r,o,s;for(e=[],i=o=0,s=t.length;s>o;i=++o)r=t[i],e[i]=this.clamp(Math.round(r*n),0,255);return e},brightenColor:function(t,n){var e,i,r,o;for(e=[],r=0,o=t.length;o>r;r++)i=t[r],e.push(this.clamp(Math.round(i+255*n),0,255));return e},colorString:function(t){return null==t.string&&(4===t.length&&t[3]>1&&this.error("alpha > 1"),t.string=3===t.length?"rgb("+t+")":"rgba("+t+")"),t.string},colorsEqual:function(t,n){return t.toString()===n.toString()},isLittleEndian:function(){var t;return t=new Uint32Array([16909060]),4===new Uint8ClampedArray(t.buffer)[0]},degreesToRadians:function(t){return t*Math.PI/180},radiansToDegrees:function(t){return 180*t/Math.PI},substractRadians:function(t,n){var e,i;return i=t-n,e=Math.PI,-e>=i&&(i+=2*e),i>e&&(i-=2*e),i},ownKeys:function(t){var n,e;return ABM.Array.from(function(){var i;i=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],i.push(n));return i}())},ownVariableKeys:function(t){var n,e;return ABM.Array.from(function(){var i;i=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],this.isFunction(e)||i.push(n));return i}.call(this))},ownValues:function(t){var n,e;return ABM.Array.from(function(){var i;i=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],i.push(e));return i}())},angle:function(t,n,e){return e.isTorus?this.angleTorus(t,n,e):this.angleEuclidian(t,n)},angleEuclidian:function(t,n){return Math.atan2(n.y-t.y,n.x-t.x)},angleTorus:function(t,n,e){var i;return i=this.closestTorusPoint(t,n,e.width,e.height),this.angleEuclidian(t,i)},inCone:function(t,n,e,i,r,o){return o.isTorus?u.inConeTorus(t,n,e,i,r,o):u.inConeEuclidian(t,n,e,i,r)},inConeEuclidian:function(t,n,e,i,r){var o;return e<this.distanceEuclidian(i,r)?!1:(o=this.angleEuclidian(i,r),n/2>=Math.abs(this.substractRadians(t,o)))},inConeTorus:function(t,n,e,i,r,o){var s,a,u,l;for(l=this.torus4Points(i,r,o.width,o.height),a=0,u=l.length;u>a;a++)if(s=l[a],this.inConeEuclidian(t,n,e,i,s))return!0;return!1},distance:function(t,n,e){return e.isTorus?this.distanceTorus(t,n,e):this.distanceEuclidian(t,n)},distanceEuclidian:function(t,n){var e,i;return e=t.x-n.x,i=t.y-n.y,Math.sqrt(e*e+i*i)},distanceTorus:function(t,n,e){var i,r,o,s;return o=Math.abs(n.x-t.x),s=Math.abs(n.y-t.y),i=Math.min(o,e.width-o),r=Math.min(s,e.height-s),Math.sqrt(i*i+r*r)},torus4Points:function(t,n,e,i){var r,o,s;return s=this.torusReflect(t,n,e,i),r=s[0],o=s[1],[n,{x:r,y:n.y},{x:n.x,y:o},{x:r,y:o}]},closestTorusPoint:function(t,n,e,i){var r,o,s,a,u;return u=this.torusReflect(t,n,e,i),o=u[0],a=u[1],r=Math.abs(o-t.x)<Math.abs(n.x-t.x)?o:n.x,s=Math.abs(a-t.y)<Math.abs(n.y-t.y)?a:n.y,{x:r,y:s}},torusReflect:function(t,n,e,i){var r,o;return r=n.x<t.x?n.x+e:n.x-e,o=n.y<t.y?n.y+i:n.y-i,[r,o]},fileIndex:{},importImage:function(t,n){var e;return null==n&&(n=function(){}),e=this.fileIndex[t],null!=e?e.isDone&&n(e):(e=new Image,e.isDone=!1,e.crossOrigin="Anonymous",e.onload=function(){return n(e),e.isDone=!0},e.src=t,this.fileIndex[t]=e),e},xhrLoadFile:function(t,n,e,i){var r;return null==n&&(n="GET"),null==e&&(e="text"),null==i&&(i=function(){}),r=this.fileIndex[t],null!=r?r.isDone&&i(r.response):(r=new XMLHttpRequest,r.isDone=!1,r.open(n,t),r.responseType=e,r.onload=function(){return i(r.response),r.isDone=!0},this.fileIndex[t]=r,r.send()),r},filesLoaded:function(t){var n,e;return null==t&&(t=this.fileIndex),n=function(){var n,i,r,o;for(r=this.ownValues(t),o=[],n=0,i=r.length;i>n;n++)e=r[n],o.push(e.isDone);return o}.call(this),n.reduce(function(t,n){return t&&n},!0)},waitOnFiles:function(t,n){return null==n&&(n=this.fileIndex),this.waitOn(function(t){return function(){return t.filesLoaded(n)}}(this),t)},waitOn:function(t,n){return t()?n():setTimeout(function(e){return function(){return e.waitOn(t,n)}}(this),1e3)},cloneImage:function(t){var n;return n=new Image,n.src=t.src,n},imageToData:function(t,n,e){return null==n&&(n=this.pixelByte(0)),null==e&&(e=Uint8ClampedArray),this.imageRowsToData(t,t.height,n,e)},imageRowsToData:function(t,n,e,i){var r,o,s,a,u,l,h,c,p;for(null==e&&(e=this.pixelByte(0)),null==i&&(i=Uint8ClampedArray),h=0,o=new i(t.width*t.height);h<t.height;){for(l=Math.min(t.height-h,n),r=this.imageSliceToContext(t,0,h,t.width,l),u=this.contextToImageData(r).data,s=h*t.width,a=c=0,p=u.length/4;p>c;a=c+=1)o[s+a]=e(u,4*a);h+=l}return o},imageSliceToContext:function(t,n,e,i,r,o){return null!=o?(o.canvas.width=i,o.canvas.height=r):o=this.createContext(i,r),o.drawImage(t,n,e,i,r,0,0,i,r),o},pixelByte:function(t){return function(n,e){return n[e+t]}},createCanvas:function(t,n){var e;return e=document.createElement("canvas"),e.width=t,e.height=n,e},createContext:function(t,n,e){var i,r;return null==e&&(e="2d"),i=this.createCanvas(t,n),"2d"===e?i.getContext("2d"):null!=(r=i.getContext("webgl"))?r:i.getContext("experimental-webgl")},createLayer:function(t,n,e,i,r){var o;return null==r&&(r="2d"),"img"===r?(o=r=new Image,r.width=n,r.height=e):o=(r=this.createContext(n,e,r)).canvas,this.insertLayer(t,o,n,e,i),r},insertLayer:function(t,n,e,i,r){return n.setAttribute("style","position:absolute;top:0;left:0;width:"+e+";height:"+i+";z-index:"+r),t.appendChild(n)},setContextSmoothing:function(t,n){return t.imageSmoothingEnabled=n,t.mozImageSmoothingEnabled=n,t.oImageSmoothingEnabled=n,t.webkitImageSmoothingEnabled=n},setIdentity:function(t){return t.save(),t.setTransform(1,0,0,1,0,0)},clearContext:function(t){return null!=t.save?(this.setIdentity(t),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillContext:function(t,n){return null!=t.fillStyle?(this.setIdentity(t),t.fillStyle=this.colorString(n),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,__slice.call(n).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},contextDrawText:function(t,n,e,i,r,o){return null==r&&(r=[0,0,0]),null==o&&(o=!0),o&&this.setIdentity(t),t.fillStyle=this.colorString(r),t.fillText(n,e,i),o?t.restore():void 0},contextTextParams:function(t,n,e,i){return null==e&&(e="center"),null==i&&(i="middle"),t.font=n,t.textAlign=e,t.textBaseline=i},elementTextParams:function(t,n,e,i){return null==e&&(e="center"),null==i&&(i="middle"),null!=t.canvas&&(t=t.canvas),t.style.font=n,t.style.textAlign=e,t.style.textBaseline=i},contextToDataUrl:function(t){return t.canvas.toDataURL("image/png")},contextToDataUrlImage:function(t,n){var e;return e=new Image,null!=n&&(e.onload=function(){return n(e)}),e.src=t.canvas.toDataURL("image/png"),e},contextToImageData:function(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},drawCenteredImage:function(t,n,e,i,r,o,s){return t.translate(i,r),t.rotate(e),t.drawImage(n,-o/2,-s/2)},copyContext:function(t){var n;return n=this.createContext(t.canvas.width,t.canvas.height),n.drawImage(t.canvas,0,0),n},resizeContext:function(t,n,e,i){var r;return null==i&&(i=!1),r=this.copyContext(t),t.canvas.width=n,t.canvas.height=e,t.drawImage(r.canvas,0,0)},linearInterpolate:function(t,n,e){return t+(n-t)*e},identityFunction:function(t){return t},propertyFunction:function(t){return function(n){return n[t]}},propertySortFunction:function(t){return function(n,e){return n[t]<e[t]?-1:n[t]>e[t]?1:0}},typedToJS:function(t){var n,e,i,r;for(r=[],e=0,i=t.length;i>e;e++)n=t[e],r.push(n);return r}},ABM.util.array={from:function(t,n){return ABM.Array.from(t,n)},toString:function(t){var n;return"["+function(){var e,i,r;for(r=[],e=0,i=t.length;i>e;e++)n=t[e],r.push(n.toString());return r}().join(", ")+"]"},toFixed:function(t,n){var e,i,r,o;for(null==n&&(n=2),e=[],r=0,o=t.length;o>r;r++)i=t[r],e.push(i.toFixed(n));return e},any:function(t){return!this.empty(t)},empty:function(t){return 0===t.length},clone:function(t,n,e){var i;return null==n&&(n=null),null==e&&(e=null),i=null!=t.slice?"slice":"subarray",null!=n?t[i](n,e):t[i](0)},first:function(t){return t[0]},last:function(t){return this.empty(t)?void 0:t[t.length-1]},sample:function(t,n,e){var i,r,o,s;if(null==n&&(n=null),null==e&&(e=null),u.isFunction(n)?e=n:null!=n&&(o=Math.floor(n)),null!=o){for(r=new ABM.Array,s=!0;r.length<o&&null!=s;)s=this.sample(t,e),s&&__indexOf.call(r,s)<0&&r.push(s);return r}if(null==e)return this.empty(t)?null:t[u.randomInt(t.length)];for(i=new ABM.Array;i.length<t.length;)if(s=this.sample(t),s&&__indexOf.call(i,s)<0&&(i.push(s),e(s)))return s},contains:function(t,n){return t.indexOf(n)>=0},remove:function(t,n){for(var e;;){if(e=t.indexOf(n),-1===e)break;t.splice(e,1)}return t},removeItems:function(t,n){var e,i,r;for(i=0,r=n.length;r>i;i++)e=n[i],this.remove(t,e);return t},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},min:function(t,n,e){var i,r,o,s,a,l;for(null==n&&(n=u.identityFunction),null==e&&(e=!1),this.empty(t)&&u.error("min: empty array"),u.isString(n)&&(n=u.propertyFunction(n)),r=1/0,i=null,a=0,l=t.length;l>a;a++)o=t[a],s=n(o),r>s&&(r=s,i=o);return e?[i,r]:i},max:function(t,n,e){var i,r,o,s,a,l;for(null==n&&(n=u.identityFunction),null==e&&(e=!1),this.empty(t)&&u.error("max: empty array"),u.isString(n)&&(n=u.propertyFunction(n)),r=-1/0,i=null,a=0,l=t.length;l>a;a++)o=t[a],s=n(o),s>r&&(r=s,i=o);return e?[i,r]:i},sum:function(t,n){var e,i,r,o;for(null==n&&(n=u.identityFunction),u.isString(n)&&(n=u.propertyFunction(n)),i=0,r=0,o=t.length;o>r;r++)e=t[r],i+=n(e);return i},average:function(t,n){return null==n&&(n=u.identityFunction),this.sum(t,n)/t.length},median:function(t){var n;return t=null!=t.sort?this.clone(t):u.typedToJS(t),n=(t.length-1)/2,this.sort(t),(t[Math.floor(n)]+t[Math.ceil(n)])/2},histogram:function(t,n,e){var i,r,o,s,a,l,h,c;for(null==n&&(n=1),null==e&&(e=u.identityFunction),u.isString(e)&&(e=u.propertyFunction(e)),i=[],a=0,h=t.length;h>a;a++)o=t[a],r=Math.floor(e(o)/n),i[r]||(i[r]=0),i[r]+=1;for(r=l=0,c=i.length;c>l;r=++l)s=i[r],null==s&&(i[r]=0);return i},sort:function(t,n){return null==n&&(n=null),u.isString(n)&&(n=u.propertySortFunction(n)),t._sort(n)},uniq:function(t){var n,e;for(n={},e=0;e<t.length;)n[t[e]]===!0?(t.splice(e,1),e-=1):n[t[e]]=!0,e+=1;return t},flatten:function(t){return t.reduce(function(t,n){return u.isArray(t)||(t=new ABM.Array(t)),t.concat(n)})},concat:function(t,n){var e,i,r,o;if(i=t.clone(),u.isArray(n))for(r=0,o=n.length;o>r;r++)e=n[r],i.push(e);else i.push(n);return i},normalize:function(t,n,e){var i,r,o,s,a,l,h;for(null==n&&(n=0),null==e&&(e=1),r=this.min(t),i=this.max(t),a=1/(i-r),o=[],l=0,h=t.length;h>l;l++)s=t[l],o.push(u.linearInterpolate(n,e,a*(s-r)));return o},normalizeInt:function(t,n,e){var i,r,o,s,a;for(s=this.normalize(t,n,e),a=[],r=0,o=s.length;o>r;r++)i=s[r],a.push(Math.round(i));return a},normalize8:function(t){return new Uint8ClampedArray(this.normalize(t,-.5,255.5))},ask:function(array,functionString){var object,_i,_len;for(u.isString(functionString)&&eval("functionString=function(o){return "+functionString+";}"),_i=0,_len=array.length;_len>_i;_i++)object=array[_i],functionString(object);return array},"with":function(array,functionString){var object;return u.isString(functionString)&&eval("f=function(o){return "+functionString+";}"),this.from(function(){var t,n,e;for(e=[],t=0,n=array.length;n>t;t++)object=array[t],functionString(object)&&e.push(object);return e}())},getProperty:function(t,n){var e,i,r,o;for(o=[],i=0,r=t.length;r>i;i++)e=t[i],o.push(e[n]);return o},getPropertyWith:function(t,n,e){var i;return this.from(function(){var r,o,s;for(s=[],r=0,o=t.length;o>r;r++)i=t[r],i[n]===e&&s.push(i);return s}())},setProperty:function(t,n,e){var i,r,o,s,a,l;if(u.isArray(e))for(i=o=0,a=t.length;a>o;i=++o)r=t[i],r[n]=e[i];else for(s=0,l=t.length;l>s;s++)r=t[s],r[n]=e;return t},other:function(t,n){var e;return this.from(function(){var i,r,o;for(o=[],i=0,r=t.length;r>i;i++)e=t[i],e!==n&&o.push(e);return o}())}},ABM.util.array.extender={methods:function(){var t,n,e,i;e=ABM.util.array,i=[];for(t in e)n=e[t],"function"==typeof n&&i.push(t);return i},extendArray:function(className){var method,methods,_i,_len,_results;for(methods=this.methods(),_results=[],_i=0,_len=methods.length;_len>_i;_i++)method=methods[_i],_results.push(eval(""+className+".prototype."+method+" = function() {\n  var options, _ref, _ret;\n  options = 1 <= arguments.length ? __slice.call(arguments, 0) : [];\n  _ret = (_ref = u.array)."+method+".apply(_ref, [this].concat(__slice.call(options)));\n  if (ABM.util.isArray(_ret)) {\n    return this.constructor.from(_ret);\n  } else {\n    return _ret;\n  }\n};"));return _results}},(_base=Array.prototype).indexOf||(_base.indexOf=function(t){var n,e,i,r;for(n=i=0,r=this.length;r>i;n=++i)if(e=this[n],e===t)return n;return-1}),Array.prototype._sort=Array.prototype.sort,ABM.Array=function(t){function n(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],this.constructor.from(t)}return __extends(n,t),n.from=function(t,n){var e;return null==n&&(n=ABM.Array),t.__proto__=null!=(e=n.prototype)?e:n.constructor.prototype,t},n}(Array),ABM.util.array.extender.extendArray("ABM.Array"),ABM.util.shapes=function(){var t,n,e,i,r,o,a;return o=function(t,n){var e,i,r,o;for(e=r=0,o=n.length;o>r;e=++r)i=n[e],0===e?t.moveTo(i[0],i[1]):t.lineTo(i[0],i[1]);return null},e=function(t,n,e,i){return t.arc(n,e,i/2,0,2*Math.PI)},t=function(t,n,e,i){return t.arc(n,e,i/2,0,2*Math.PI,!0)},n=function(t,n,e,i,r){return t.scale(1,-1),t.drawImage(r,n-i/2,e-i/2,i,i),t.scale(1,-1)},i=function(t,n,e,i){return t.fillRect(n-i/2,e-i/2,i,i)},r=function(t,n){return t.context.save(),t.context.scale(1,-1),t.context.drawImage(n,t.x,-(t.y+t.spriteSize),t.spriteSize,t.spriteSize),t.context.restore()},a=new ABM.Array,{"default":{rotate:!0,draw:function(t){return o(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return o(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return o(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){return t.strokeStyle=t.fillStyle,t.lineWidth=.05,o(t,[[.4,.225],[.2,0],[.4,-.225]]),t.stroke(),t.beginPath(),e(t,.12,0,.26),e(t,-.05,0,.26),e(t,-.27,0,.4)}},pyramid:{rotate:!1,draw:function(t){return o(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{shortcut:function(t,n,i,r){return t.beginPath(),e(t,n,i,r),t.closePath(),t.fill()},rotate:!1,draw:function(t){return e(t,0,0,1)}},square:{shortcut:function(t,n,e,r){return i(t,n,e,r)},rotate:!1,draw:function(t){return i(t,0,0,1)}},pentagon:{rotate:!1,draw:function(t){return o(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(n){return e(n,0,0,1),n.closePath(),t(n,0,0,.6)}},filledRing:{rotate:!1,draw:function(t){var n;return e(t,0,0,1),n=t.fillStyle,t.fillStyle=t.strokeStyle,t.fill(),t.fillStyle=n,t.beginPath(),e(t,0,0,.8)}},person:{rotate:!1,draw:function(t){return o(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),e(t,0,.35,.3)}},names:function(){var t,n,e;t=new ABM.Array;for(n in this)__hasProp.call(this,n)&&(e=this[n],null!=e.rotate&&null!=e.draw&&t.push(n));return t},add:function(t,e,i,r){var o;return o=u.isFunction(i)?{rotate:e,draw:i}:{rotate:e,img:i,draw:function(t){return n(t,.5,.5,1,this.img)}},this[t]=o,null!=r?o.shortcut=r:null==o.img||o.rotate?void 0:o.shortcut=function(t,e,i,r){return n(t,e,i,r,this.img)}},poly:o,circ:e,ccirc:t,cimg:n,csq:i,spriteSheets:a,draw:function(t,n,e,i,r,o,s,a){return null!=n.shortcut?(null==n.img&&(t.fillStyle=u.colorString(s)),n.shortcut(t,e,i,r)):(t.save(),t.translate(e,i),1!==r&&t.scale(r,r),0!==o&&t.rotate(o),null!=n.img?n.draw(t):(t.fillStyle=u.colorString(s),a&&(t.strokeStyle=u.colorStr(a),t.lineWidth=.05),t.save(),t.beginPath(),n.draw(t),t.closePath(),t.restore(),t.fill(),a&&t.stroke()),t.restore()),n},drawSprite:function(t,n,e,i,r,o){return 0===o?t.drawImage(s.context.canvas,n.x,n.y,n.spriteSize,n.spriteSize,e-r/2,i-r/2,r,r):(t.save(),t.translate(e,i),t.rotate(o),t.drawImage(n.context.canvas,n.x,n.y,n.spriteSize,n.spriteSize,-r/2,-r/2,r,r),t.restore()),n},shapeToSprite:function(t,n,e,i){var o,s,l,h,c,p,f,d,m,y,g;return d=Math.ceil(e),m=4,f=d+m,c=this[t],h=null!=c.img?t:""+t+"-"+u.colorString(n),o=a[f],null==o&&(a[f]=o=u.createContext(10*f,f),o.nextX=0,o.nextY=0,o.index={}),null!=(s=o.index[h])?s:(f*o.nextX===o.canvas.width&&(u.resizeContext(o,o.canvas.width,o.canvas.height+f),o.nextX=0,o.nextY++),y=f*o.nextX+m/2,g=f*o.nextY+m/2,p={context:o,x:y,y:g,size:e,spriteSize:d,name:t,color:n,strokeColor:i,index:h},o.index[h]=p,null!=(l=c.img)?0!==l.height?r(p,l):l.onload=function(){return r(p,l)}:(o.save(),o.translate((o.nextX+.5)*f,(o.nextY+.5)*f),o.scale(d,d),o.fillStyle=u.colorString(n),i&&(o.strokeStyle=u.colorString(i),o.lineWidth=.05),o.save(),o.beginPath(),c.draw(o),o.closePath(),o.restore(),o.fill(),i&&o.stroke(),o.restore()),o.nextX++,p)}}}(),ABM.Set=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.from=function(t,n){var e;return null==n&&(n=this.model.Set),t.__proto__=null!=(e=n.prototype)?e:n.constructor.prototype,t},n.prototype.from=function(t,n){return null==n&&(n=this),this.model.Set.from(t,n)},n.prototype.setDefault=function(t,n){return this.agentClass.prototype[t]=n,this},n.prototype.exclude=function(t){var n;return t=t.split(" "),this.from(function(){var e,i,r,o;for(o=[],e=0,i=this.length;i>e;e++)n=this[e],r=n.breed.name,__indexOf.call(t,r)<0&&o.push(n);return o}.call(this))},n.prototype.draw=function(t){var n,e,i;for(u.clearContext(t),e=0,i=this.length;i>e;e++)n=this[e],n.hidden||n.draw(t);return null},n.prototype.show=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.hidden=!1;return this.draw(this.model.contexts[this.name])},n.prototype.hide=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.hidden=!0;return this.draw(this.model.contexts[this.name])},n.prototype.inRadius=function(t,n){var e,i,r,o;for(i=new this.model.Set,r=0,o=this.length;o>r;r++)e=this[r],e.distance(t)<=n.radius&&i.push(e);return i},n.prototype.inCone=function(t,n){var e,i,r,o;for(i=new this.model.Set,r=0,o=this.length;o>r;r++)e=this[r],u.inCone(n.heading,n.cone,n.radius,t,e.position,this.model.patches)&&i.push(e);return i},n}(ABM.Array),ABM.BreedSet=function(t){function n(t,e,i){n.__super__.constructor.call(this,0),this.agentClass=t,this.name=e,this.mainSet=i,null==this.mainSet&&(this.breeds=[],this.ID=0),this.agentClass.prototype.breed=this}return __extends(n,t),n.prototype.create=function(){},n.prototype.originalPush=n.prototype.push,n.prototype.push=function(){var t,n,e,i;if(n=1<=arguments.length?__slice.call(arguments,0):[],n.length>1)for(e=0,i=n.length;i>e;e++)t=n[e],this.push(t);else n=n[0],this.originalPush(n),null!=this.mainSet?this.mainSet.push(n):null!=n.id?null!=n.breed&&n.breed.name===!this.name&&(n.id=this.ID++):n.id=this.ID++;return n},n.prototype.add=function(t){return this.push(t)},n.prototype.remove=function(t){return null!=this.mainSet&&this.mainSet.remove(t),u.array.remove(this,t),this},n.prototype.pop=function(){var t;return t=this.last(),this.remove(t),t},n.prototype.setBreed=function(t){var n,e,i;t.breed.remove(t),this.push(t),e=t.__proto__=this.agentClass.prototype;for(n in t)__hasProp.call(t,n)&&(i=t[n],null!=e[n]&&delete t[n]);return t},n.prototype.floodFill=function(t,n,e,i,r,o){var s,a;for(null==o&&(o=[]),s=this.floodFillOnce(t,n,e,i,r,o),a=[];s;)a.push(s=s());return a},n.prototype.floodFillOnce=function(t,n,e,i,r,o){var s,a,u,l,h,c,p,f,d,m,y;for(null==o&&(o=[]),h=0,f=t.length;f>h;h++)u=t[h],e(u,o);for(s=[],c=0,d=t.length;d>c;c++)for(u=t[c],y=r(u),p=0,m=y.length;m>p;p++)a=y[p],n(a,t)&&s.indexOf(a)<0&&s.push(a);return l=i&&i(t,s),l||0===s.length?null:function(o){return function(){return o.floodFillOnce(s,n,e,i,r,t)}}(this)},n.prototype.asOrderedSet=function(t){return this.from(t).sort("id")},n}(ABM.Set),ABM.Agent=function(){function t(){this.position={x:0,y:0},null==this.color&&(this.color=u.randomColor()),null==this.heading&&(this.heading=u.randomFloat(2*Math.PI)),this.links=new ABM.Array,this.moveTo(this.position)}return t.prototype.id=null,t.prototype.breed=null,t.prototype.position=null,t.prototype.patch=null,t.prototype.size=1,t.prototype.color=null,t.prototype.strokeColor=null,t.prototype.shape="default",t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.penDown=!1,t.prototype.penSize=1,t.prototype.heading=null,t.prototype.sprite=null,t.prototype.links=null,t.prototype.toString=function(){return"{id: "+this.id+", position: {x: "+this.position.x.toFixed(2)+","+(" y: "+this.position.y.toFixed(2)+"}, c: "+this.color+", h: "+this.heading.toFixed(2)+"}")},t.prototype.moveTo=function(t){var n,e,i,r,o;return this.penDown&&(o=[this.position.x,this.position.y],i=o[0],r=o[1]),this.position=this.model.patches.coordinate(t),e=this.patch,this.patch=this.model.patches.patch(this.position),e&&e!==this.patch&&e.agents.remove(this),this.patch.agents.push(this),this.penDown?(n=this.model.drawing,n.strokeStyle=u.colorString(this.color),n.lineWidth=this.model.patches.fromBits(this.penSize),n.beginPath(),n.moveTo(i,r),n.lineTo(this.position.x,this.position.y),n.stroke()):void 0},t.prototype.moveOff=function(){return this.patch&&this.patch.agents.remove(this),this.patch=this.position=null},t.prototype.forward=function(t){return this.moveTo({x:this.position.x+t*Math.cos(this.heading),y:this.position.y+t*Math.sin(this.heading)})},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.face=function(t){return this.heading=u.angle(this.position,t,this.model.patches)},t.prototype.distance=function(t){return u.distance(this.position,t,this.model.patches)},t.prototype.neighbors=function(t){var n,e,i,r,o,s,a,u,l,h;if(null==t&&(t=1),t.radius)r=this.neighbors(t.radius),t.cone?(null==t.heading&&(t.heading=this.heading),e=r.inCone(this.position,t)):e=r.inRadius(this.position,t);else if(e=this.breed.from([]),this.patch)for(l=this.patch.neighbors(t),o=0,a=l.length;a>o;o++)for(i=l[o],h=i.agents,s=0,u=h.length;u>s;s++)n=h[s],n!==this&&e.push(n);return e},t.prototype.die=function(){var t,n,e;for(this.breed.remove(this),e=this.links,n=e.length-1;n>=0;n+=-1)t=e[n],t.die();return this.moveOff(),null},t.prototype.hatch=function(t,n,e){return null==t&&(t=1),null==n&&(n=this.model.agents),null==e&&(e=function(){}),n.create(t,function(t){return function(n){var i,r;n.moveTo(t.position);for(i in t)__hasProp.call(t,i)&&(r=t[i],"id"!==i&&(n[i]=r));return e(n),n}}(this))},t.prototype.otherEnd=function(t){return t.from===this?t.to:t.from},t.prototype.outLinks=function(){var t,n,e,i,r;for(i=this.links,r=[],n=0,e=i.length;e>n;n++)t=i[n],t.from===this&&r.push(t);return r},t.prototype.inLinks=function(){var t,n,e,i,r;for(i=this.links,r=[],n=0,e=i.length;e>n;n++)t=i[n],t.to===this&&r.push(t);return r},t.prototype.linkNeighbors=function(){var t,n,e,i,r;for(t=new ABM.Array,r=this.links,e=0,i=r.length;i>e;e++)n=r[e],t.push(this.otherEnd(n));return t.uniq()},t.prototype.inLinkNeighbors=function(){var t,n,e,i,r;for(t=new ABM.Array,r=this.inLinks(),e=0,i=r.length;i>e;e++)n=r[e],t.push(n.from);return t.uniq()},t.prototype.outLinkNeighbors=function(){var t,n,e,i,r;for(t=new ABM.Array,r=this.outLinks(),e=0,i=r.length;i>e;e++)n=r[e],t.push(n.to);return t.uniq()},t.prototype.draw=function(t){var n,e,i,r,o;if(null!==this.patch)return e=u.shapes[this.shape],n=e.rotate?this.heading:0,null!=this.sprite||this.breed.useSprites?(null==this.sprite&&this.setSprite(),u.shapes.drawSprite(t,this.sprite,this.position.x,this.position.y,this.size,n)):u.shapes.draw(t,e,this.position.x,this.position.y,this.size,n,this.color,this.strokeColor),null!=this.label?(o=this.model.patches.patchXYtoPixelXY(this.x,this.y),i=o[0],r=o[1],u.contextDrawText(t,this.label,i+this.labelOffset[0],r+this.labelOffset[1],this.labelColor)):void 0},t.prototype.setSprite=function(t){return null!=t?(this.sprite=t,this.color=t.color,this.strokeColor=t.strokeColor,this.shape=t.shape,this.size=t.size):(null==this.color&&(this.color=u.randomColor),this.sprite=u.shapes.shapeToSprite(this.shape,this.color,this.model.patches.toBits(this.size),this.strokeColor))},t.prototype.stamp=function(){return this.draw(this.model.drawing)},t}(),ABM.Agents=function(t){function n(){n.__super__.constructor.apply(this,arguments),this.useSprites=!1}return __extends(n,t),n.prototype.setUseSprites=function(t){this.useSprites=null!=t?t:!0},n.prototype["in"]=function(t){var n,e,i,r;for(e=[],i=0,r=t.length;r>i;i++)n=t[i],n.breed===this&&e.push(n);return this.from(e)},n.prototype.create=function(t,n){var e,i,r;for(null==n&&(n=function(){}),r=[],e=i=1;t>=i;e=i+=1)r.push(function(t){return n(t),t}(this.add(new this.agentClass)));return r},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.neighboring=function(t,n){var e;return e=t.neighbors(n),this["in"](e)},n.prototype.formCircle=function(t,n,e){var i,r,o,s,a;for(null==n&&(n=Math.PI/2),null==e&&(e=-1),r=2*Math.PI/this.length,o=s=0,a=this.length;a>s;o=++s)i=this[o],i.moveTo({x:0,y:0}),i.heading=n+e*r*o,i.forward(t);return null},n}(ABM.BreedSet),ABM.Animator=function(){function t(t,n,e){this.model=t,this.rate=null!=n?n:30,this.multiStep=null!=e?e:t.world.isHeadless,this.animateDraws=__bind(this.animateDraws,this),this.animateSteps=__bind(this.animateSteps,this),this.isHeadless=t.world.isHeadless,this.reset()}return t.prototype.setRate=function(t,n){return this.rate=t,this.multiStep=null!=n?n:this.isHeadless,this.resetTimes()},t.prototype.start=function(){return this.stopped?(this.resetTimes(),this.stopped=!1,this.animate()):void 0},t.prototype.stop=function(){return this.stopped=!0,null!=this.animatorHandle&&cancelAnimFrame(this.animatorHandle),null!=this.timeoutHandle&&clearTimeout(this.timeoutHandle),null!=this.intervalHandle&&clearInterval(this.intervalHandle),this.animatorHandle=this.timerHandle=this.intervalHandle=null},t.prototype.resetTimes=function(){return this.startMS=this.now(),this.startTick=this.ticks,this.startDraw=this.draws},t.prototype.reset=function(){return this.stop(),this.ticks=this.draws=0},t.prototype.step=function(){return this.ticks++,this.model.step()},t.prototype.draw=function(){return this.draws++,this.model.draw()},t.prototype.once=function(){return this.step(),this.draw()},t.prototype.now=function(){return("undefined"!=typeof performance&&null!==performance?performance:Date).now()},t.prototype.ms=function(){return this.now()-this.startMS},t.prototype.ticksPerSec=function(){var t;return t=this.ticks-this.startTick,0===t?0:Math.round(1e3*t/this.ms())},t.prototype.drawsPerSec=function(){var t;return t=this.draws-this.startDraw,0===t?0:Math.round(1e3*t/this.ms())},t.prototype.toString=function(){return"ticks: "+this.ticks+", draws: "+this.draws+", rate: "+this.rate+" "+("tps/dps: "+this.ticksPerSec()+"/"+this.drawsPerSec())},t.prototype.animateSteps=function(){return this.step(),this.stopped?void 0:this.timeoutHandle=setTimeout(this.animateSteps,10)},t.prototype.animateDraws=function(){return this.isHeadless?this.ticksPerSec()<this.rate&&this.step():this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw()),this.stopped?void 0:this.animatorHandle=requestAnimFrame(this.animateDraws)},t.prototype.animate=function(){return this.multiStep&&this.animateSteps(),this.isHeadless&&this.multiStep?void 0:this.animateDraws()},t}(),ABM.Link=function(){function t(t,n){this.from=t,this.to=n,this.from.links.push(this),this.to.links.push(this)}return t.prototype.id=null,t.prototype.breed=null,t.prototype.from=null,t.prototype.to=null,t.prototype.color=[130,130,130],t.prototype.thickness=2,t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.draw=function(t){var n,e,i,r,o,s;return t.save(),t.strokeStyle=u.colorString(this.color),t.lineWidth=this.model.patches.fromBits(this.thickness),t.beginPath(),this.model.patches.isTorus?(n=u.closestTorusPoint(this.from.position,this.to.position,this.model.patches.numX,this.model.patches.numY),t.moveTo(this.from.position.x,this.from.position.y),t.lineTo(n.x,n.y),(n.x!==this.to.position.x||n.y!==this.to.position.y)&&(n=u.closestTorusPoint(this.to.position,this.from.position,this.model.patches.numX,this.model.patches.numY),t.moveTo(this.to.position.x,this.to.position.y),t.lineTo(n.x,n.y))):(t.moveTo(this.from.position.x,this.from.position.y),t.lineTo(this.to.position.x,this.to.position.y)),t.closePath(),t.stroke(),t.restore(),null!=this.label?(i=u.linearInterpolate(this.from.position.x,this.to.position.x,.5),o=u.linearInterpolate(this.from.position.y,this.to.position.y,.5),s=this.model.patches.patchXYtoPixelXY(i,o),e=s[0],r=s[1],u.contextDrawText(t,this.label,e+this.labelOffset[0],r+this.labelOffset[1],this.labelColor)):void 0},t.prototype.die=function(){return this.breed.remove(this),this.from.links.remove(this),this.to.links.remove(this),null
},t.prototype.bothEnds=function(){return new ABM.Array(this.from,this.to)},t.prototype.length=function(){return this.from.distance(this.to.position)},t.prototype.otherEnd=function(t){return this.from===t?this.to:this.from},t}(),ABM.Links=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.create=function(t,n,e){var i,r,o,s;for(null==e&&(e=function(){}),null==n.length&&(n=[n]),s=[],r=0,o=n.length;o>r;r++)i=n[r],s.push(function(t){return e(t),t}(this.add(new this.agentClass(t,i))));return s},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.nodesWithDups=function(){var t,n,e,i;for(n=new this.model.Set,e=0,i=this.length;i>e;e++)t=this[e],n.push(t.from,t.to);return n},n.prototype.nodes=function(){return this.nodesWithDups().uniq()},n}(ABM.BreedSet),ABM.Patch=function(){function t(t){this.position=t,this.neighborsCache={},this.agents=new ABM.Array}return t.prototype.id=null,t.prototype.breed=null,t.prototype.position=null,t.prototype.color=[0,0,0],t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.agents=null,t.prototype.toString=function(){return"{id:"+this.id+" position: {x: "+this.position.x+", y: "+this.position.y+"},"+("c: "+this.color+"}")},t.prototype.draw=function(t){var n;return t.fillStyle=u.colorString(this.color),t.fillRect(this.position.x-.5,this.position.y-.5,1,1),null!=this.label?(n=this.breed.patchXYtoPixelXY(this.position),u.contextDrawText(t,this.label,n.x+this.labelOffset[0],n.y+this.labelOffset[1],this.labelColor)):void 0},t.prototype.empty=function(){return this.agents.empty()},t.prototype.isOnEdge=function(){return this.position.x===this.breed.min.x||this.position.x===this.breed.max.x||this.position.y===this.breed.min.y||this.position.y===this.breed.max.y},t.prototype.sprout=function(t,n,e){return null==t&&(t=1),null==n&&(n=this.model.agents),null==e&&(e=function(){}),n.create(t,function(t){return function(n){return n.moveTo(t.position),e(n),n}}(this))},t.prototype.distance=function(t){return u.distance(this.position,t,this.model.patches)},t.prototype.neighbors=function(t){var n,e,i;return null==t&&(t=1),u.isNumber(t)&&(t={range:t}),(null==t.cache||t.cache)&&(n=JSON.stringify(t),e=this.neighborsCache[n]),null==e&&(t.radius?(i=this.neighbors({range:t.radius,meToo:t.meToo},{cache:t.cache}),t.cone?(e=i.inCone(this.position,t),t.cache||(n=null)):e=i.inRadius(this.position,t)):e=t.diamond?this.diamondNeighbors(t.diamond,t.meToo):this.breed.patchRectangle(this,t.range,t.range,t.meToo),null!=n&&(this.neighborsCache[n]=e)),e},t.prototype.diamondNeighbors=function(t,n){var e,i,r,o,s,a,u,l,h,c,p;for(u=this.breed.patchRectangleNullPadded(this,t,t,!0),r=new this.model.Set,i=0,l=0,e=-1,h=2*t+1,c=0,p=u.length;p>c;c++)a=u[c],l=i%h,0===l&&(e+=1),o=Math.abs(e-t),s=Math.abs(l-t),t>=s+o&&(n||s+o!==0)&&r.push(a),i+=1;return r.remove(null),r},t}(),ABM.Patches=function(t){function n(){var t,e,i;n.__super__.constructor.apply(this,arguments),this.monochrome=!1,i=this.model.world;for(t in i)__hasProp.call(i,t)&&(e=i[t],this[t]=e)}return __extends(n,t),n.prototype.create=function(){var t,n,e,i,r,o,s,a;for(n=e=r=this.max.y,o=this.min.y;e>=o;n=e+=-1)for(t=i=s=this.min.x,a=this.max.x;a>=i;t=i+=1)this.add(new this.agentClass({x:t,y:n}));return this.isHeadless||this.setPixels(),this},n.prototype.patch=function(t){var n,e;return n=this.isCoordinate(t,this.min,this.max)?t:this.coordinate(t,this.min,this.max),e={x:Math.round(n.x),y:Math.round(n.y)},this[this.patchIndex(e)]},n.prototype.coordinate=function(t,n,e){return null==n&&(n=this.minCoordinate),null==e&&(e=this.maxCoordinate),this.isTorus?this.wrap(t,n,e):this.clamp(t,n,e)},n.prototype.clamp=function(t,n,e){return null==n&&(n=this.minCoordinate),null==e&&(e=this.maxCoordinate),{x:u.clamp(t.x,n.x,e.x),y:u.clamp(t.y,n.y,e.y)}},n.prototype.wrap=function(t,n,e){return null==n&&(n=this.minCoordinate),null==e&&(e=this.maxCoordinate),{x:u.wrap(t.x,n.x,e.x),y:u.wrap(t.y,n.y,e.y)}},n.prototype.isCoordinate=function(t,n,e){var i,r;return null==n&&(n=this.minCoordinate),null==e&&(e=this.maxCoordinate),n.x<=(i=t.x)&&i<=e.x&&n.y<=(r=t.y)&&r<=e.y},n.prototype.isOnWorld=function(t){return this.isTorus||this.isCoordinate(t)},n.prototype.patchIndex=function(t){return t.x-this.min.x+this.width*(this.max.y-t.y)},n.prototype.randomPoint=function(){return{x:u.randomFloat(this.minCoordinate.x,this.maxCoordinate.x),y:u.randomFloat(this.minCoordinate.y,this.maxCoordinate.y)}},n.prototype.toBits=function(t){return t*this.patchSize},n.prototype.fromBits=function(t){return t/this.patchSize},n.prototype.patchRectangle=function(t,n,e,i){var r;return null==i&&(i=!1),r=this.patchRectangleNullPadded(t,n,e,i),r.remove(null)},n.prototype.patchRectangleNullPadded=function(t,n,e,i){var r,o,s,a,u,l,h,c,p,f;for(null==i&&(i=!1),o=new this.model.Set,a=u=h=t.position.y-e,c=t.position.y+e;c>=u;a=u+=1)for(s=l=p=t.position.x-n,f=t.position.x+n;f>=l;s=l+=1)r=null,this.isTorus?(s<this.min.x&&(s+=this.width),s>this.max.x&&(s-=this.width),a<this.min.y&&(a+=this.height),a>this.max.y&&(a-=this.height),r=this.patch({x:s,y:a})):s>=this.min.x&&s<=this.max.x&&a>=this.min.y&&a<=this.max.y&&(r=this.patch({x:s,y:a})),(i||t!==r)&&o.push(r);return o},n.prototype.importDrawing=function(t,n){return u.importImage(t,function(t){return function(e){return t.installDrawing(e),null!=n?n():void 0}}(this))},n.prototype.installDrawing=function(t,n){return null==n&&(n=this.model.contexts.drawing),u.setIdentity(n),n.drawImage(t,0,0,n.canvas.width,n.canvas.height),n.restore()},n.prototype.pixelByteIndex=function(t){return 4*t.id},n.prototype.pixelWordIndex=function(t){return t.id},n.prototype.pixelXYtoPatchXY=function(t,n){return[this.minCoordinate.x+t/this.patchSize,this.maxCoordinate.y-n/this.patchSize]},n.prototype.patchXYtoPixelXY=function(t,n){return[(t-this.minCoordinate.x)*this.patchSize,(this.maxCoordinate.y-n)*this.patchSize]},n.prototype.importColors=function(t,n,e){return u.importImage(t,function(t){return function(i){return t.installColors(i,e),null!=n?n():void 0}}(this))},n.prototype.installColors=function(t,n){var e,i,r,o,s;for(u.setIdentity(this.pixelsContext),this.pixelsContext.drawImage(t,0,0,this.width,this.height),e=this.pixelsContext.getImageData(0,0,this.width,this.height).data,o=0,s=this.length;s>o;o++)r=this[o],i=this.pixelByteIndex(r),r.color=null!=n?n[i]:[e[i++],e[i++],e[i]];return this.pixelsContext.restore()},n.prototype.drawScaledPixels=function(t){return 1!==this.patchSize&&u.setIdentity(t),null!=this.pixelsData32?this.drawScaledPixels32(t):this.drawScaledPixels8(t),1!==this.patchSize?t.restore():void 0},n.prototype.drawScaledPixels8=function(t){var n,e,i,r,o,s,a,u,l;for(i=this.pixelsData,a=0,l=this.length;l>a;a++){for(s=this[a],r=this.pixelByteIndex(s),e=s.color,n=4===e.length?e[3]:255,o=u=0;2>=u;o=++u)i[r+o]=e[o];i[r+3]=n}return this.pixelsContext.putImageData(this.pixelsImageData,0,0),1!==this.patchSize?t.drawImage(this.pixelsContext.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.drawScaledPixels32=function(t){var n,e,i,r,o,s,a;for(i=this.pixelsData32,s=0,a=this.length;a>s;s++)o=this[s],r=this.pixelWordIndex(o),e=patch.color,n=4===e.length?e[3]:255,i[r]=this.pixelsAreLittleEndian?n<<24|e[2]<<16|e[1]<<8|e[0]:e[0]<<24|e[1]<<16|e[2]<<8|n;return this.pixelsContext.putImageData(this.pixelsImageData,0,0),1!==this.patchSize?t.drawImage(this.pixelsContext.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.floodFillOnce=function(t,e,i,r,o,s){return null==o&&(o=function(t){return t.n}),null==s&&(s=[]),n.__super__.floodFillOnce.call(this,t,e,i,r,o,s)},n.prototype.diffuse=function(t,n,e){var i,r,o,s,a,l,h,c,p,f,d,m,y,g;if(null==this[0]._diffuseNext)for(l=0,f=this.length;f>l;l++)a=this[l],a._diffuseNext=0;for(h=0,d=this.length;d>h;h++)for(a=this[h],i=a[t]*n,r=i/8,s=a.neighbors().length,a._diffuseNext+=a[t]-i+(8-s)*r,g=a.neighbors(),c=0,m=g.length;m>c;c++)o=g[c],o._diffuseNext+=r;for(p=0,y=this.length;y>p;p++)a=this[p],a[t]=a._diffuseNext,a._diffuseNext=0,e&&(a.color=u.fractionOfColor(e,a[t]));return null},n.prototype.usePixels=function(t){var n;return this.drawWithPixels=null!=t?t:!0,n=this.model.contexts.patches,u.setContextSmoothing(n,!this.drawWithPixels)},n.prototype.setPixels=function(){return 1===this.patchSize?(this.usePixels(),this.pixelsContext=this.model.contexts.patches):this.pixelsContext=u.createContext(this.width,this.height),this.pixelsImageData=this.pixelsContext.getImageData(0,0,this.width,this.height),this.pixelsData=this.pixelsImageData.data,this.pixelsData instanceof Uint8Array?(this.pixelsData32=new Uint32Array(this.pixelsData.buffer),this.pixelsAreLittleEndian=u.isLittleEndian()):void 0},n.prototype.draw=function(t){return this.monochrome?u.fillContext(t,this.agentClass.prototype.color):this.drawWithPixels?this.drawScaledPixels(t):n.__super__.draw.call(this,t)},n}(ABM.BreedSet)}).call(this);