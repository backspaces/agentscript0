(function(){ABM.TileDataSet=function(){function t(t,i,e){this.tileSize=e||256,this.tiles={},this.width=t,this.height=i,this.zoom=0,this.origin={x:0,y:0}}return t.prototype=new ABM.DataSet,t.prototype.getXY=function(t,i){this.checkXY(t,i);var e=this.getTileContainingPoint(t,i),o={x:this.origin.x+t,y:this.origin.y+i},n=o.x%this.tileSize,l=o.y%this.tileSize,r=e.getImageData(n,l,1,1).data,a=this.parseTileData(r);return a},t.prototype.bilinear=function(t,i){this.checkXY(t,i);var e=Math.floor(t),o=Math.floor(i),t=t-e,i=i-o,n=1-t,l=1-i,r=this.getXY(e,o),a=this.getXY(e,o+1),s=this.getXY(e+1,o),h=this.getXY(e+1,o+1);return r*n*l+s*t*l+a*n*i+h*t*i},t.prototype.addTile=function(t,i){var e=[t.z,t.x,t.y].join("/");this.tiles[e]=i},t.prototype.getTileContainingPoint=function(t,i){var e=this.zoom,o={x:this.origin.x+t,y:this.origin.y+i},n=Math.floor(o.x/this.tileSize),l=Math.floor(o.y/this.tileSize),r=this.tiles[e+"/"+n+"/"+l];return r||console.log("ERR: tried to sample tile",e,n,l,"but it doesn't exist."),r},t.prototype.parseTileData=function(t){return t},t.prototype.bindToLeaflet=function(t,i,e){function o(t){var i=/.*\/(\d+)\/(\d+)\/(\d+)\.png$/,e=i.exec(t);return e&&{z:e[1],x:e[2],y:e[3]}}if(this.leafletMap=t,this.leafletLayer=i,!e){this.embedLeaflet();var n=this.leafletMap.getSize();this.width=n.x,this.height=n.y}this.tileSize=this.tileSize||i._getTileSize(),this.origin=this.leafletMap.getPixelBounds().min,this.zoom=t.getZoom(),i.on("tileload",function(t){var i=o(t.url);if(!i)return void console.log("err: couldn't parse tile coordinates for",t.url);var e=ABM.util.imageToCtx(t.tile,this.tileSize,this.tileSize);this.addTile(i,e)}.bind(this)),t.on("zoomstart",function(){this.tiles={}}.bind(this)),t.on("moveend",function(){this.origin=this.leafletMap.getPixelBounds().min}.bind(this)),t.on("zoomend",function(){this.zoom=this.leafletMap.getZoom()}.bind(this)),this.on=function(t,i){var e=this.leafletLayer;e&&e.on(t,i)};var l=!0,r=!1;i.on("loading",function(){r=!1}),t.on("movestart",function(){l=!1}),i.on("load",function(){r=!0,l&&this.leafletLayer.fire("tilesready")}.bind(this)),t.on("moveend",function(){l=!0,r&&this.leafletLayer.fire("tilesready")}.bind(this))},t.prototype.embedLeaflet=function(){return ABM.model.div?(ABM.util.insertLayer(ABM.model.div,this.leafletMap.getContainer(),ABM.world.pxWidth+"px",ABM.world.pxHeight+"px",15),void this.leafletMap.invalidateSize()):void console.log("ERR: Tried to embed leaflet map into a headless model, or before model div was initialized.")},t}()}).call(this),L.CrossOriginTileLayer=L.TileLayer.extend({_createTile:function(){var t=L.TileLayer.prototype._createTile.apply(this);return t.crossOrigin="",t}}),L.crossOriginTileLayer=function(t,i){return new L.CrossOriginTileLayer(t,i)};